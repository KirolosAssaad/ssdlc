# Security-focused Nginx configuration snippets
# Include this file in your main server configuration for enhanced security

# Security headers map for different content types
map $sent_http_content_type $security_headers {
    default "X-Frame-Options: DENY; X-Content-Type-Options: nosniff; X-XSS-Protection: 1; mode=block";
    ~image/ "X-Content-Type-Options: nosniff";
    ~font/ "X-Content-Type-Options: nosniff";
}

# Rate limiting configurations
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api_strict:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=general_strict:10m rate=60r/m;

# Geo-blocking (example - customize as needed)
geo $blocked_country {
    default 0;
    # Add country codes to block if needed
    # CN 1;  # China
    # RU 1;  # Russia
}

# Bot detection
map $http_user_agent $blocked_agent {
    default 0;
    ~*malicious 1;
    ~*bot 1;
    ~*crawler 1;
    ~*spider 1;
    "" 1;  # Empty user agent
}

# Security configuration block
server {
    # ... (your existing server configuration)
    
    # Block malicious requests
    if ($blocked_country) {
        return 403 "Access denied from your location";
    }
    
    if ($blocked_agent) {
        return 403 "Blocked user agent";
    }
    
    # Block common attack patterns
    location ~* (eval\(|javascript:|vbscript:|onload=|onerror=|onclick=) {
        deny all;
        access_log off;
        return 403;
    }
    
    # Block SQL injection attempts
    location ~* (union.*select|insert.*into|delete.*from|drop.*table) {
        deny all;
        access_log off;
        return 403;
    }
    
    # Block file inclusion attacks
    location ~* (\.\.\/|\.\.\\|etc\/passwd|proc\/self\/environ) {
        deny all;
        access_log off;
        return 403;
    }
    
    # Block common exploit attempts
    location ~* (phpinfo|phpmyadmin|wp-admin|wp-login|xmlrpc\.php) {
        deny all;
        access_log off;
        return 403;
    }
    
    # Strict authentication rate limiting
    location ~* ^/(api/)?(auth|login|signin) {
        limit_req zone=login burst=3 nodelay;
        
        # Additional security headers for auth endpoints
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        
        # Continue to your auth handling
        try_files $uri @backend;
    }
    
    # Strict API rate limiting
    location /api/ {
        limit_req zone=api_strict burst=10 nodelay;
        
        # Security headers for API
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Cache-Control "no-cache" always;
        
        # Continue to your API handling
        try_files $uri @backend;
    }
    
    # File upload security
    location /api/upload {
        # Strict rate limiting for uploads
        limit_req zone=api_strict burst=2 nodelay;
        
        # File size limit
        client_max_body_size 10M;
        
        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        
        # Continue to your upload handling
        try_files $uri @backend;
    }
    
    # Admin area protection (if applicable)
    location /admin {
        # Allow only specific IPs (customize as needed)
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
        
        # Additional authentication can be added here
        auth_basic "Admin Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        try_files $uri @backend;
    }
    
    # Security monitoring and logging
    location = /security-log {
        access_log /var/log/nginx/security.log combined;
        return 204;
    }
    
    # Honeypot for attackers
    location /wp-admin {
        access_log /var/log/nginx/attacks.log combined;
        return 404;
    }
    
    location /phpmyadmin {
        access_log /var/log/nginx/attacks.log combined;
        return 404;
    }
    
    # Block access to sensitive files
    location ~* \.(env|git|svn|htaccess|htpasswd|ini|log|config)$ {
        deny all;
        access_log off;
        return 404;
    }
    
    # Block access to backup files
    location ~* \.(bak|backup|old|orig|save|swo|swp|tmp)$ {
        deny all;
        access_log off;
        return 404;
    }
    
    # Custom error pages with security headers
    error_page 403 /403.html;
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /403.html {
        root /usr/share/nginx/html;
        internal;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    location = /404.html {
        root /usr/share/nginx/html;
        internal;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
}